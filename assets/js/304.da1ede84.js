(window.webpackJsonp=window.webpackJsonp||[]).push([[304],{648:function(t,s,a){"use strict";a.r(s);var n=a(15),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"方案一"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方案一"}},[t._v("#")]),t._v(" 方案一")]),t._v(" "),s("ul",[s("li",[t._v("构建")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# 内置变量：CI_JOB_TOKEN，会自动传入（写在gitlab-ci.yaml中）\ndocker build --build-arg CI_JOB_TOKEN=$CI_JOB_TOKEN -f Dockerfile -t $some_tag .\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("ul",[s("li",[t._v("docker")])]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("ARG CI_JOB_TOKEN\nENV CI_JOB_TOKEN=$CI_JOB_TOKEN\nRUN git config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('global url."https'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ci"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("token"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_JOB_TOKEN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('@gitlab.private/group".insteadOf "git@gitlab.private'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('group"\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("h2",{attrs:{id:"方案二"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方案二"}},[t._v("#")]),t._v(" 方案二")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('- go env -w GOPROXY=https://goproxy.io,direct\n- go env -w GOPRIVATE=git.hongyuan.com/spider\n- echo -e "machine git.hongyuan.com\\nlogin $GITLAB_USERNAME \\npassword $GITLAB_PASSWORD" > ~/.netrc\n- chmod 600 ~/.netrc\n- git config --global --add  url."git@hongyuan.com:".insteadof "https://git.hongyuan.com/"\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h2",{attrs:{id:"demo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#demo"}},[t._v("#")]),t._v(" demo")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" check\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cd\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("check_code")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" check\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" golang"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.19")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("except")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" main\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" go env "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w GOPROXY=https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//goproxy.io"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("direct\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" go env "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w GOPRIVATE=git.xxx.com/spider\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.53.3")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('e "machine git.xxx.com\\nlogin $GITLAB_USERNAME \\npassword $GITLAB_PASSWORD" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" ~/.netrc\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chmod 600 ~/.netrc\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("global "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('add  url."git@xxx.com'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('".insteadof "https'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('//git.xxx.com/"\n  '),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - go mod vendor")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - golangci-lint run")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" make all\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("after_script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export TZ='Asia/Shanghai'\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' export build_time=$(date +"%Y'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("%m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("%d %H"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("%M"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('%S")\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export repository_url=$(git config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get remote.origin.url)\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export commit_author=$(git log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pretty=format"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('"%an")\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export commit_message=$(git log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pretty=format"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('"%s")\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export REPO_NAME=$(basename "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('s .git "$repository_url")\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' export build_logs_url="$'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_URL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("/jobs/$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_JOB_ID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n      if [ $? -eq 0 ]; then\n        export check_status="Job Success"\n        export check_color="green"\n      else\n        export check_status="Job failed"\n        export check_color="red"\n      fi')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' curl "https'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//open.feishu.cn/open"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("apis/bot/v2/hook/$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("LARK_TOKEN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('H "Content'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("Type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('application/json" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('d "'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"msg_type\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"interactive\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"card\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"config\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"wide_screen_mode\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"enable_forward\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"header\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"title\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"Gitlab Runner\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"plain_text\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"template\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"$check_color\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"elements\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"markdown\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"'),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**Repository:**")]),t._v(' $REPO_NAME\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"markdown\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"'),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**Commit")]),t._v(" Author"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v(' $commit_author\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"markdown\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"'),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**Commit")]),t._v(" Message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v(' $commit_message\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"markdown\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"'),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**Check")]),t._v(" Status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v(' $check_status\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"div\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"text\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"lark_md\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"'),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**Build")]),t._v(" Log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Please Click Me"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v('($build_logs_url)\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"note\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"elements\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v('\\"tag\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"plain_text\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('\\"content\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('\\"$build_time\\"'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n\n'),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build_image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" main\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("stable\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' export IMAGE_TAG="registry.cn'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("beijing.aliyuncs.com/biyao/spider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_COMMIT_SHA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n  '),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $IMAGE_TAG\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "$'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("ACR_PASSWORD"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" docker login registry.cn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("beijing.aliyuncs.com "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("ACR_USERNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("stdin\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build . "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("file Dockerfile "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("tag $IMAGE_TAG "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('arg "CI_JOB_TOKEN=$'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_JOB_TOKEN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('arg "GITLAB_USERNAME=$'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("GITLAB_USERNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('arg "GITLAB_PASSWORD=$'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("GITLAB_PASSWORD"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push $IMAGE_TAG\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cd-job")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cd\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" smartive/kustomize\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" main\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' export IMAGE_TAG="registry.cn'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("beijing.aliyuncs.com/biyao/spider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_COMMIT_SHA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("global user.name xxx\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("global user.email xxx@xxx.com\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git clone https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("xxx@git.xxx.com/spider/BiyaoCD.git\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n      export ARGO_APP=$(echo $CI_PROJECT_NAME | tr \'[A-Z]\' \'[a-z]\')\n      echo "$ARGO_APP"\n      echo "print CI_COMMIT_TITLE"\n      echo "$CI_COMMIT_TITLE"\n      if [ -d "BiyaoCD/${ARGO_APP}/overlays" ]; then\n        cd BiyaoCD/${ARGO_APP}/overlays\n        # 发布到测试环境\n        if [[ "$CI_COMMIT_REF_NAME" != "main" ]]; then\n          if echo "$CI_COMMIT_TITLE" | grep -q "passgateway"; then\n            cd passgateway/dev && kustomize edit set image k8s_image=${IMAGE_TAG} && cd ../../\n          elif echo "$CI_COMMIT_TITLE" | grep -q "signgateway"; then\n            cd signgateway/dev && kustomize edit set image k8s_image=${IMAGE_TAG} && cd ../../\n          elif echo "$CI_COMMIT_TITLE" | grep -q "modelgateway"; then\n            cd modelgateway/dev && kustomize edit set image k8s_image=${IMAGE_TAG} && cd ../../\n          else\n            echo "Please select branch";\n            exit 1;\n          fi\n        fi')]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 发布到生产环境")]),t._v("\n        if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(' "$CI_COMMIT_REF_NAME" == "main" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v('; then\n          if echo "$CI_COMMIT_TITLE" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" grep "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('q "passgateway"; then\n            cd passgateway/prod '),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" kustomize edit set image k8s_image=$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("IMAGE_TAG"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(' cd ../../\n          elif echo "$CI_COMMIT_TITLE" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" grep "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('q "signgateway"; then\n            cd signgateway/dev '),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" kustomize edit set image k8s_image=$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("IMAGE_TAG"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(' cd ../../\n          elif echo "$CI_COMMIT_TITLE" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" grep "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('q "modelgateway"; then\n            cd modelgateway/dev '),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" kustomize edit set image k8s_image=$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("IMAGE_TAG"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(' cd ../../\n          else\n            echo "Please select branch";\n            exit 1;\n          fi      \n        fi\n        git add .\n        '),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v('git commit -m "CD')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" update $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("ARGO_APP"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("IMAGE_TAG"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n        git fetch '),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" git rebase origin/main "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" git push\n      fi\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br"),s("span",{staticClass:"line-number"},[t._v("40")]),s("br"),s("span",{staticClass:"line-number"},[t._v("41")]),s("br"),s("span",{staticClass:"line-number"},[t._v("42")]),s("br"),s("span",{staticClass:"line-number"},[t._v("43")]),s("br"),s("span",{staticClass:"line-number"},[t._v("44")]),s("br"),s("span",{staticClass:"line-number"},[t._v("45")]),s("br"),s("span",{staticClass:"line-number"},[t._v("46")]),s("br"),s("span",{staticClass:"line-number"},[t._v("47")]),s("br"),s("span",{staticClass:"line-number"},[t._v("48")]),s("br"),s("span",{staticClass:"line-number"},[t._v("49")]),s("br"),s("span",{staticClass:"line-number"},[t._v("50")]),s("br"),s("span",{staticClass:"line-number"},[t._v("51")]),s("br"),s("span",{staticClass:"line-number"},[t._v("52")]),s("br"),s("span",{staticClass:"line-number"},[t._v("53")]),s("br"),s("span",{staticClass:"line-number"},[t._v("54")]),s("br"),s("span",{staticClass:"line-number"},[t._v("55")]),s("br"),s("span",{staticClass:"line-number"},[t._v("56")]),s("br"),s("span",{staticClass:"line-number"},[t._v("57")]),s("br"),s("span",{staticClass:"line-number"},[t._v("58")]),s("br"),s("span",{staticClass:"line-number"},[t._v("59")]),s("br"),s("span",{staticClass:"line-number"},[t._v("60")]),s("br"),s("span",{staticClass:"line-number"},[t._v("61")]),s("br"),s("span",{staticClass:"line-number"},[t._v("62")]),s("br"),s("span",{staticClass:"line-number"},[t._v("63")]),s("br"),s("span",{staticClass:"line-number"},[t._v("64")]),s("br"),s("span",{staticClass:"line-number"},[t._v("65")]),s("br"),s("span",{staticClass:"line-number"},[t._v("66")]),s("br"),s("span",{staticClass:"line-number"},[t._v("67")]),s("br"),s("span",{staticClass:"line-number"},[t._v("68")]),s("br"),s("span",{staticClass:"line-number"},[t._v("69")]),s("br"),s("span",{staticClass:"line-number"},[t._v("70")]),s("br"),s("span",{staticClass:"line-number"},[t._v("71")]),s("br"),s("span",{staticClass:"line-number"},[t._v("72")]),s("br"),s("span",{staticClass:"line-number"},[t._v("73")]),s("br"),s("span",{staticClass:"line-number"},[t._v("74")]),s("br"),s("span",{staticClass:"line-number"},[t._v("75")]),s("br"),s("span",{staticClass:"line-number"},[t._v("76")]),s("br"),s("span",{staticClass:"line-number"},[t._v("77")]),s("br"),s("span",{staticClass:"line-number"},[t._v("78")]),s("br"),s("span",{staticClass:"line-number"},[t._v("79")]),s("br"),s("span",{staticClass:"line-number"},[t._v("80")]),s("br"),s("span",{staticClass:"line-number"},[t._v("81")]),s("br"),s("span",{staticClass:"line-number"},[t._v("82")]),s("br"),s("span",{staticClass:"line-number"},[t._v("83")]),s("br"),s("span",{staticClass:"line-number"},[t._v("84")]),s("br"),s("span",{staticClass:"line-number"},[t._v("85")]),s("br"),s("span",{staticClass:"line-number"},[t._v("86")]),s("br"),s("span",{staticClass:"line-number"},[t._v("87")]),s("br"),s("span",{staticClass:"line-number"},[t._v("88")]),s("br"),s("span",{staticClass:"line-number"},[t._v("89")]),s("br"),s("span",{staticClass:"line-number"},[t._v("90")]),s("br"),s("span",{staticClass:"line-number"},[t._v("91")]),s("br"),s("span",{staticClass:"line-number"},[t._v("92")]),s("br"),s("span",{staticClass:"line-number"},[t._v("93")]),s("br"),s("span",{staticClass:"line-number"},[t._v("94")]),s("br"),s("span",{staticClass:"line-number"},[t._v("95")]),s("br"),s("span",{staticClass:"line-number"},[t._v("96")]),s("br"),s("span",{staticClass:"line-number"},[t._v("97")]),s("br"),s("span",{staticClass:"line-number"},[t._v("98")]),s("br"),s("span",{staticClass:"line-number"},[t._v("99")]),s("br"),s("span",{staticClass:"line-number"},[t._v("100")]),s("br"),s("span",{staticClass:"line-number"},[t._v("101")]),s("br"),s("span",{staticClass:"line-number"},[t._v("102")]),s("br"),s("span",{staticClass:"line-number"},[t._v("103")]),s("br"),s("span",{staticClass:"line-number"},[t._v("104")]),s("br"),s("span",{staticClass:"line-number"},[t._v("105")]),s("br")])]),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://juejin.cn/post/7166171734754721829",target:"_blank",rel:"noopener noreferrer"}},[t._v("Go + Docker技巧-私人仓库和Gitlab CI"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.cn/jh/user/project/repository/mirror/",target:"_blank",rel:"noopener noreferrer"}},[t._v("仓库镜像"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.cn/post/6844903984554049544",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker安装Gitlab和Runner并实现CICD"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);